#!/bin/bash

# CONFIGURATION
BASE_IP="192.168.105"
START_OCTET=190
INTERFACE="wlan0"
SUBNET="24"

CURRENT_OCTET=$START_OCTET

echo "Scanning for available IP in range ${BASE_IP}.${START_OCTET}..."

while true; do
    TARGET_IP="${BASE_IP}.${CURRENT_OCTET}"
    
    # Check if IP is in use (ping 2 times, wait 1 second)
    if ping -c 2 -W 1 "$TARGET_IP" > /dev/null 2>&1; then
        echo "Address $TARGET_IP is BUSY. Trying next..."
        ((CURRENT_OCTET++))
        
        if [ $CURRENT_OCTET -gt 254 ]; then
            echo "Error: No available IPs found in subnet."
            exit 1
        fi
    else
        echo "Address $TARGET_IP is FREE. Assigning to $INTERFACE..."
        # Add the IP alias
        sudo ip addr add "${TARGET_IP}/${SUBNET}" dev "$INTERFACE" label "${INTERFACE}:static"
        
        echo "SUCCESS: Pi is now reachable at $TARGET_IP (Static) AND its DHCP address."
        break
    fi
    else
        echo "Address $TARGET_IP is FREE. Assigning to $INTERFACE..."
        # Add the IP alias (WITHOUT sudo here)
        ip addr add "${TARGET_IP}/${SUBNET}" dev "$INTERFACE" label "${INTERFACE}:static"
        
        echo "SUCCESS: Pi is now reachable at $TARGET_IP (Static) AND its DHCP address."
        break
    fi
done
